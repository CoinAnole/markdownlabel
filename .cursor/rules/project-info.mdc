---
alwaysApply: true
---

Project: Kivy Garden MarkdownLabel — a Kivy Garden flower that renders Markdown documents as interactive
Kivy UI. It offers a Label-compatible API for easy migration but extends BoxLayout (and is not a drop-in
Label replacment) because Markdown rendering builds multiple widgets; supports full Markdown syntax,
links, headings, lists, tables, code blocks, and styling controls.

Purpose/target: Give Kivy apps rich formatted text without hand-building widget trees. Targeted at
Kivy developers who need Markdown content with Label-like properties and link callbacks.

Key features:
- Full Markdown blocks: headings, paragraphs, lists, tables, quotes, fenced code, images.
- Inline formatting: bold/italic/strike/code/links with markup escaping.
- Interactive links via `on_ref_press`; configurable fonts/colors/sizes.
- Built on mistune 3.x with plugins (tables, strikethrough).

Architecture: Three-layer rendering pipeline:
1. **Parsing**: mistune parses Markdown → AST tokens
2. **Block Rendering**: `KivyRenderer` converts blocks → Kivy widgets
3. **Inline Rendering**: `InlineRenderer` converts inline → markup strings

Uses multiple inheritance pattern: `MarkdownLabel(MarkdownLabelProperties, MarkdownLabelRendering,
BoxLayout)` for separation of concerns. `MarkdownSerializer` supports AST→Markdown round-trips for tests.

Key architectural constraints:
- **Nesting depth protection**: KivyRenderer limits recursion depth to prevent stack overflow
- **Property forwarding**: Properties must propagate to child Label widgets for Label API compatibility
- **Rebuild contract**: STYLE_ONLY_PROPERTIES update in-place; STRUCTURE_PROPERTIES trigger full rebuild
- **Backward compatibility**: Split modules re-export for existing imports
- **Markup escaping**: InlineRenderer must escape user content to prevent markup injection

Property system: Properties classified as STYLE_ONLY_PROPERTIES (update in-place) or
STRUCTURE_PROPERTIES (trigger full rebuild). See `kivy_garden/markdownlabel/REBUILD_CONTRACT.md` for
semantics. Properties forward to child Label widgets for Label API compatibility.

Package/namespace: Modern Kivy Garden flower using namespace package `kivy_garden.markdownlabel` (not
legacy `garden.*`); import via `from kivy_garden.markdownlabel import MarkdownLabel`.

Component responsibilities (all in `kivy_garden/markdownlabel/`):
| Component | File | Role |
|-----------|------|------|
| MarkdownLabel | `__init__.py` | Main widget, Label API compatibility, event dispatch |
| MarkdownLabelProperties | `properties.py` | Property definitions, STYLE_ONLY/STRUCTURE classification |
| MarkdownLabelRendering | `rendering.py` | Widget tree building, `_update_*_in_place` methods |
| KivyRenderer | `kivy_renderer.py` | Block rendering, nesting depth protection |
| KivyRendererTables | `kivy_renderer_tables.py` | Table rendering mixin |
| InlineRenderer | `inline_renderer.py` | Inline → BBCode (`[b]`, `[i]`, `[ref=url]`) |
| MarkdownSerializer | `markdown_serializer.py` | AST→Markdown serialization for tests |
| Utils | `utils.py` | Internal helpers (widget traversal, testing support) |

Packaging/deps: Python 3.8–3.12; installable as `kivy_garden.markdownlabel` (see `setup.py`). Runtime
deps: `kivy>=2.0.0`, `mistune>=3.0.0`; extras for dev/test use pytest, hypothesis, coverage, sphinx.
Flake8 config lives in `setup.cfg`.

Docs: Sphinx sources under `doc/`; published at https://kivy-garden.github.io/markdownlabel/.

Testing: pytest property-based tests in `kivy_garden/markdownlabel/tests/` organized by functionality
(not by implementation file); they set `KIVY_NO_ARGS=1` and `KIVY_NO_CONSOLELOG=1` for headless runs—keep
those when running CI locally (e.g., `pytest` from repo root). Tests grouped by functionality:
`test_font_properties.py`, `test_rebuild_*`, etc. Property-based tests use Hypothesis with documented
`max_examples`. See `tests/TESTING.md` for comprehensive testing guidelines, Hypothesis optimization
rules, and documented exceptions for private method testing (e.g., `_get_effective_render_mode()`
allowed when no public API equivalent exists). See `tests/TEST_MAP.md` for complete test suite catalog
and navigation guide. Meta-tests in `tests/meta_tests/` validate test infrastructure.

Modification patterns:
- **Adding Markdown feature**: Check mistune support (may need plugin) → Add to `KivyRenderer` (blocks)
  or `InlineRenderer` (inline) → Add serialization in `MarkdownSerializer` → Add tests in appropriate
  functional test file
- **Adding Label-compatible property**: Define in `properties.py` → Forward in `rendering.py` → Test in
  `test_*_properties.py`

Repo structure note: `external/` contains vendored upstream Kivy and Mistune sources/docs/examples;
usually leave untouched unless updating vendored copies. Configuration files: `setup.cfg` (Flake8, 110
char lines), `pytest.ini` (test config), `.coveragerc` (coverage settings),
`kivy_garden/markdownlabel/REBUILD_CONTRACT.md` (property rebuild semantics).
