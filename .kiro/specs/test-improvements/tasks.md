# Implementation Plan

- [x] 1. Remove timing-based assertions and fix meta-test reliability
  - [x] 1.1 Replace timing assertions in test_refactoring_properties.py
    - Remove all timing assertions with lower bounds (>= 0.5s) and upper bounds (<= 15s)
    - Replace with functional checks: return codes, test collection counts, output verification
    - Add PYTEST_DISABLE_PLUGIN_AUTOLOAD=1 to subprocess environment
    - _Requirements: 1.1, 1.2, 1.3, 1.4_
  - [x] 1.2 Fix silent-pass patterns in test_core_functionality_properties.py
    - Replace "if os.path.exists(...): ..." with "assert Path(...).exists()"
    - Remove broad "except Exception: pass" statements
    - Replace with specific exception handling or let exceptions propagate
    - _Requirements: 2.1, 2.2, 2.4_
  - [x] 1.3 Write property test for no timing assertions
    - **Property 1: No timing assertions in tests**
    - **Validates: Requirements 1.1, 1.2**
  - [x] 1.4 Write property test for subprocess pytest configuration
    - **Property 2: Subprocess pytest uses stable configuration**
    - **Validates: Requirements 1.3, 1.4**
  - [x] 1.5 Write property test for no silent-pass file checks
    - **Property 3: No silent-pass file existence checks**
    - **Validates: Requirements 2.1**
  - [x] 1.6 Write property test for no broad exception handling
    - **Property 4: No broad exception handling**
    - **Validates: Requirements 2.2, 2.4**

- [x] 2. Convert inappropriate property tests to parametrized tests
  - [x] 2.1 Identify fixed-list property tests in test suite
    - Scan all test files for @given(st.sampled_from(...)) patterns
    - Create list of tests that should be converted to parametrized
    - Document conversion mapping for each identified test
    - _Requirements: 3.1_
  - [x] 2.2 Convert fixed-list property tests to parametrized tests
    - Replace @given(st.sampled_from([...])) with @pytest.mark.parametrize
    - Ensure parameter names are descriptive and clear
    - Maintain same test coverage and edge cases
    - _Requirements: 3.1, 3.4_
  - [x] 2.3 Write property test for fixed-list conversion
    - **Property 5: Fixed-list property tests converted**
    - **Validates: Requirements 3.1, 3.4**

- [x] 3. Implement URL markup safety testing and fixes
  - [x] 3.1 Add URL escaping to InlineRenderer.link() method
    - Implement URL escaping for closing brackets and markup characters
    - Ensure escaped URLs still function as clickable links
    - Handle edge cases like multiple brackets and nested markup
    - _Requirements: 4.1, 4.2, 4.4_
  - [x] 3.2 Create comprehensive URL safety test suite
    - Test URLs with ], [, and other markup-breaking characters
    - Verify links still function correctly after escaping
    - Test edge cases like nested markup and multiple brackets
    - _Requirements: 4.3_
  - [x] 3.3 Write property test for URL markup safety
    - **Property 6: URL markup safety**
    - **Validates: Requirements 4.1, 4.2, 4.4**

- [x] 4. Implement robust code block serialization
  - [x] 4.1 Fix fence collision handling in MarkdownSerializer.block_code()
    - Implement dynamic fence length selection based on content
    - Ensure fence is longer than any backtick sequence in code
    - Handle edge cases like code containing only backticks
    - _Requirements: 5.1, 5.2_
  - [x] 4.2 Add code block serialization tests
    - Test code containing various backtick patterns
    - Verify round-trip serialization preserves content exactly
    - Test edge cases like empty code blocks and backtick-only content
    - _Requirements: 5.3, 5.4_
  - [x] 4.3 Write property test for code fence collision handling
    - **Property 7: Code fence collision handling**
    - **Validates: Requirements 5.1, 5.2**
  - [x] 4.4 Write property test for code serialization round-trip
    - **Property 8: Code serialization round-trip**
    - **Validates: Requirements 5.3, 5.4**

- [x] 5. Add inline HTML security testing
  - [x] 5.1 Implement HTML escaping in InlineRenderer.inline_html() method
    - Escape HTML tags to render as plain text
    - Prevent introduction of exploitable Kivy markup
    - Handle special characters and edge cases
    - _Requirements: 6.1, 6.2, 6.4_
  - [x] 5.2 Create HTML security test suite
    - Test various HTML tags and attributes
    - Verify HTML is rendered as plain text
    - Test potential XSS vectors and markup injection
    - _Requirements: 6.3_
  - [x] 5.3 Write property test for HTML content escaping
    - **Property 9: HTML content escaping**
    - **Validates: Requirements 6.1, 6.2, 6.4**

- [ ] 6. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 7. Mark performance tests and clean up configuration
  - [ ] 7.1 Add @pytest.mark.slow to performance-intensive tests
    - Identify genuinely heavy tests in test_performance.py
    - Add slow marker to appropriate tests
    - Configure reduced Hypothesis max_examples for CI
    - _Requirements: 7.1, 7.3_
  - [ ] 7.2 Configure CI to skip slow tests by default
    - Update pytest configuration to skip slow tests unless requested
    - Document how to run slow tests explicitly
    - Ensure fast feedback loop for default CI runs
    - _Requirements: 7.2_
  - [ ] 7.3 Remove duplicate environment setup from test files
    - Remove KIVY_NO_ARGS and KIVY_NO_CONSOLELOG from individual test files
    - Ensure all setup is centralized in conftest.py
    - Verify no test functionality is broken by centralization
    - _Requirements: 8.1, 8.4_
  - [ ] 7.4 Write property test for performance test marking
    - **Property 10: Performance tests marked**
    - **Validates: Requirements 7.1, 7.3**
  - [ ] 7.5 Write property test for no duplicate environment setup
    - **Property 11: No duplicate environment setup**
    - **Validates: Requirements 8.1, 8.4**

- [ ] 8. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.