# Implementation Plan

- [x] 1. Add no-op properties for Label API compatibility
  - [x] 1.1 Add mipmap, outline_width, outline_color properties to MarkdownLabel
    - Add BooleanProperty for mipmap (default False)
    - Add NumericProperty for outline_width (default 0)
    - Add ColorProperty for outline_color (default [0, 0, 0, 1])
    - Add docstrings documenting these as no-op properties
    - _Requirements: 1.1, 1.2_
  - [x] 1.2 Add text_language, base_direction properties to MarkdownLabel
    - Add StringProperty for text_language (default None, allownone=True)
    - Add OptionProperty for base_direction (options: None, 'ltr', 'rtl', 'weak_ltr', 'weak_rtl')
    - Add docstrings documenting these as no-op properties
    - _Requirements: 1.1, 1.2_
  - [x] 1.3 Add ellipsis_options property to MarkdownLabel
    - Add DictProperty for ellipsis_options (default {})
    - Bind to _on_style_changed for rebuild on change
    - _Requirements: 1.1, 4.5_
  - [x] 1.4 Write property test for no-op property acceptance and storage
    - **Property 1: No-op Property Acceptance and Storage**
    - **Validates: Requirements 1.1, 1.2, 1.3**

- [x] 2. Implement strict_label_mode
  - [x] 2.1 Add strict_label_mode property to MarkdownLabel
    - Add BooleanProperty with default False
    - Add docstring explaining strict vs markdown-friendly behavior
    - _Requirements: 2.1, 2.4_
  - [x] 2.2 Modify MarkdownLabel __init__ to handle strict_label_mode
    - When strict_label_mode=True, preserve size_hint_y and don't bind height
    - Bind strict_label_mode changes to handler
    - _Requirements: 2.1, 2.2, 2.3_
  - [x] 2.3 Implement _on_strict_label_mode_changed handler
    - When True: unbind height, restore size_hint_y
    - When False: apply auto_size_height behavior if enabled
    - Trigger rebuild on mode change
    - _Requirements: 2.1, 2.4_
  - [x] 2.4 Update KivyRenderer to support strict_label_mode
    - Add strict_label_mode parameter to __init__
    - Modify Label creation to conditionally bind text_size based on mode
    - _Requirements: 2.2, 2.3_
  - [x] 2.5 Update MarkdownLabel._rebuild_widgets to pass strict_label_mode
    - Pass strict_label_mode to KivyRenderer constructor
    - _Requirements: 2.2, 2.3_
  - [x] 2.6 Write property test for strict label mode sizing behavior
    - **Property 2: Strict Label Mode Sizing Behavior**
    - **Validates: Requirements 2.1, 2.2, 2.3, 2.4**

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Improve texture_size calculation
  - [x] 4.1 Update _get_texture_size to include all widget types
    - Add handling for AsyncImage (use actual size)
    - Add handling for GridLayout (use minimum_size)
    - Add handling for BoxLayout containers (recurse into children)
    - Add handling for plain Widget (use height for spacers/rules)
    - _Requirements: 3.1, 3.2_
  - [x] 4.2 Add bindings for texture_size updates on child changes
    - Bind to child widget size changes where applicable
    - Ensure texture_size updates when children resize
    - _Requirements: 3.3_
  - [x] 4.3 Write property test for comprehensive texture_size calculation
    - **Property 3: Comprehensive texture_size Calculation**
    - **Validates: Requirements 3.1, 3.2, 3.3**

- [-] 5. Forward ellipsis_options to child Labels
  - [x] 5.1 Update KivyRenderer to accept ellipsis_options parameter
    - Add ellipsis_options parameter to __init__
    - Store for use in Label creation
    - _Requirements: 4.5_
  - [x] 5.2 Forward ellipsis_options in all Label creation methods
    - Update paragraph(), heading(), block_text(), _render_table_cell()
    - Update _render_list_item() marker label
    - Only add to label_kwargs if ellipsis_options is non-empty
    - _Requirements: 4.5_
  - [x] 5.3 Update MarkdownLabel._rebuild_widgets to pass ellipsis_options
    - Pass ellipsis_options to KivyRenderer constructor
    - _Requirements: 4.5_
  - [x] 5.4 Write property test for shortening property forwarding
    - **Property 4: Shortening Property Forwarding**
    - **Validates: Requirements 4.1, 4.2, 4.3, 4.4, 4.5**

- [ ] 6. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [ ] 7. Implement coordinate translation for refs and anchors
  - [ ] 7.1 Update _get_refs to translate coordinates
    - Calculate widget position relative to MarkdownLabel
    - Translate bounding box coordinates by adding widget offset
    - Handle nested containers recursively
    - _Requirements: 5.1, 5.3_
  - [ ] 7.2 Update _get_anchors to translate coordinates
    - Calculate widget position relative to MarkdownLabel
    - Translate anchor positions by adding widget offset
    - Handle nested containers recursively
    - _Requirements: 5.2, 5.3_
  - [ ] 7.3 Write property test for coordinate translation
    - **Property 5: Coordinate Translation for refs and anchors**
    - **Validates: Requirements 5.1, 5.2, 5.3**

- [ ] 8. Verify font advanced property forwarding
  - [ ] 8.1 Verify font_family exclusion from code blocks
    - Ensure code blocks in block_code() don't receive font_family
    - Document this behavior in code comments
    - _Requirements: 6.1_
  - [ ] 8.2 Write property test for font advanced property forwarding
    - **Property 6: Font Advanced Property Forwarding**
    - **Validates: Requirements 6.1, 6.2, 6.3, 6.4, 6.5**

- [ ] 9. Implement efficient style updates
  - [ ] 9.1 Define style-only vs structure property categories
    - Create class constants for STYLE_ONLY_PROPERTIES and STRUCTURE_PROPERTIES
    - Style-only: font_size, base_font_size, color, halign, valign, line_height, disabled, disabled_color
    - Structure: text, font_name, code_font_name, text_size, strict_label_mode, padding
    - _Requirements: 7.1, 7.2, 7.3_
  - [ ] 9.2 Implement _update_styles_in_place method
    - Update font_size, color, halign, valign, line_height on existing Labels
    - Handle disabled state color switching
    - Preserve widget tree structure
    - _Requirements: 7.1_
  - [ ] 9.3 Modify _on_style_changed to use conditional update
    - Detect which property changed
    - Call _update_styles_in_place for style-only properties
    - Call _rebuild_widgets for structure properties
    - _Requirements: 7.1, 7.2, 7.3_
  - [ ] 9.4 Write property test for efficient style updates
    - **Property 7: Efficient Style Updates**
    - **Validates: Requirements 7.1, 7.2, 7.3**

- [ ] 10. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

