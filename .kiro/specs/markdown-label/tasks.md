# Implementation Plan

- [x] 1. Set up project structure and dependencies
  - Rename `kivy_garden/flower` to `kivy_garden/markdown_label`
  - Update `setup.py` to replace `flower` references with `markdown_label`
  - Add `mistune>=3.0.0` to dependencies in `setup.py`
  - Add `hypothesis>=6.0.0` to test dependencies
  - Create `__init__.py` with `MarkdownLabel` export
  - _Requirements: 1.1_

- [x] 2. Implement InlineRenderer for Kivy markup conversion
  - [x] 2.1 Create InlineRenderer class with render method
    - Implement `text()` method with Kivy markup escaping (`[` → `&bl;`, `]` → `&br;`, `&` → `&amp;`)
    - Implement `strong()` method returning `[b]...[/b]`
    - Implement `emphasis()` method returning `[i]...[/i]`
    - Implement `codespan()` method with monospace font markup
    - Implement `strikethrough()` method returning `[s]...[/s]`
    - Implement `link()` method returning `[ref=url]...[/ref]`
    - Implement `softbreak()` and `linebreak()` methods
    - _Requirements: 3.2, 3.3, 3.4, 3.5, 7.1, 13.3_
  - [x] 2.2 Write property test for inline formatting conversion
    - **Property 4: Inline Formatting Conversion**
    - **Validates: Requirements 3.2, 3.3, 3.4, 3.5**
  - [x] 2.3 Write property test for special character escaping
    - **Property 19: Special Character Escaping**
    - **Validates: Requirements 13.3**

- [x] 3. Implement KivyRenderer for block-level widgets
  - [x] 3.1 Create KivyRenderer class extending BaseRenderer
    - Implement `__call__` to return root BoxLayout
    - Implement `paragraph()` returning Label with `markup=True`
    - Implement `heading()` with font size based on level (h1=2.5x, h2=2x, h3=1.75x, h4=1.5x, h5=1.25x, h6=1x base)
    - Implement `blank_line()` returning empty widget
    - _Requirements: 2.1, 3.1_
  - [x] 3.2 Write property test for heading font hierarchy
    - **Property 3: Heading Font Size Hierarchy**
    - **Validates: Requirements 2.1**
  - [x] 3.3 Write property test for paragraph markup enabled
    - **Property 5: Paragraph Markup Enabled**
    - **Validates: Requirements 3.1**
  - [x] 3.4 Implement list rendering
    - Implement `list()` returning vertical BoxLayout
    - Implement `list_item()` with bullet/number prefix in horizontal BoxLayout
    - Handle nested lists with indentation (padding_left increases per level)
    - _Requirements: 4.1, 4.2, 4.3, 4.4_
  - [x] 3.5 Write property test for list structure
    - **Property 6: List Structure Preservation**
    - **Validates: Requirements 4.1, 4.2**
  - [x] 3.6 Write property test for nested list indentation
    - **Property 7: Nested List Indentation**
    - **Validates: Requirements 4.3**
  - [x] 3.7 Implement code block rendering
    - Implement `block_code()` with monospace font Label
    - Add dark background using canvas instructions
    - Store language info in widget attribute `language_info`
    - _Requirements: 6.1, 6.2, 6.3_
  - [x] 3.8 Write property test for code block styling
    - **Property 10: Code Block Styling**
    - **Validates: Requirements 6.1, 6.2**
  - [x] 3.9 Write property test for code block language metadata
    - **Property 11: Code Block Language Metadata**
    - **Validates: Requirements 6.3**
  - [x] 3.10 Implement block quote rendering
    - Implement `block_quote()` returning BoxLayout with left border
    - Add left padding for indentation
    - Handle nested quotes with cumulative indentation
    - _Requirements: 9.1, 9.2, 9.3_
  - [x] 3.11 Write property test for block quote structure
    - **Property 14: Block Quote Structure**
    - **Validates: Requirements 9.1**
  - [x] 3.12 Implement thematic break rendering
    - Implement `thematic_break()` returning Widget with horizontal line on canvas
    - _Requirements: 10.1_
  - [x] 3.13 Write property test for thematic break rendering
    - **Property 15: Thematic Break Rendering**
    - **Validates: Requirements 10.1**
  - [x] 3.14 Implement image rendering
    - Implement `image()` returning AsyncImage with source URL
    - Store alt text for fallback
    - _Requirements: 8.1_
  - [x] 3.15 Write property test for image widget creation
    - **Property 13: Image Widget Creation**
    - **Validates: Requirements 8.1**

- [x] 4. Implement table rendering
  - [x] 4.1 Implement table methods in KivyRenderer
    - Implement `table()` returning GridLayout with correct cols
    - Implement `table_head()`, `table_body()`, `table_row()`
    - Implement `table_cell()` with halign from alignment attribute
    - Handle empty cells with empty Label widgets
    - _Requirements: 5.1, 5.2, 5.3, 5.4_
  - [x] 4.2 Write property test for table grid structure
    - **Property 8: Table Grid Structure**
    - **Validates: Requirements 5.1**
  - [x] 4.3 Write property test for table alignment
    - **Property 9: Table Alignment Application**
    - **Validates: Requirements 5.2**

- [x] 5. Checkpoint
  - Ensure all tests pass, ask the user if questions arise.

- [x] 6. Implement MarkdownLabel widget
  - [x] 6.1 Create MarkdownLabel class extending BoxLayout
    - Add `text` StringProperty with on_text callback
    - Add styling properties: `base_font_size`, `code_font_name`, `link_color`, `code_bg_color`
    - Configure mistune parser with table, strikethrough plugins
    - Implement `_rebuild_widgets()` to parse and render
    - Set `size_hint_y=None` and bind height to content
    - _Requirements: 1.1, 1.2, 1.3, 11.1_
  - [x] 6.2 Write property test for widget tree generation
    - **Property 1: Widget Tree Generation**
    - **Validates: Requirements 1.1**
  - [x] 6.3 Write property test for reactive text updates
    - **Property 2: Reactive Text Updates**
    - **Validates: Requirements 1.2**
  - [x] 6.4 Write property test for auto-sizing behavior
    - **Property 16: Auto-Sizing Behavior**
    - **Validates: Requirements 11.1**
  - [x] 6.5 Implement link interaction
    - Register `on_ref_press` event
    - Bind child Label `on_ref_press` to bubble up to MarkdownLabel
    - _Requirements: 7.2_
  - [x] 6.6 Write property test for link ref markup
    - **Property 12: Link Ref Markup**
    - **Validates: Requirements 7.1**

- [ ] 7. Implement MarkdownSerializer for round-trip testing
  - [ ] 7.1 Create MarkdownSerializer class
    - Implement `serialize()` method to convert AST to Markdown string
    - Implement block serializers: `paragraph`, `heading`, `list`, `block_code`, `block_quote`, `table`, `thematic_break`
    - Implement `serialize_inline()` for inline token serialization
    - Add `to_markdown()` method to MarkdownLabel
    - _Requirements: 12.1, 12.2_
  - [ ] 7.2 Write property test for round-trip serialization
    - **Property 17: Round-Trip Serialization**
    - **Validates: Requirements 12.2, 12.3**

- [ ] 8. Implement edge case handling
  - [ ] 8.1 Add deep nesting protection
    - Track nesting depth during rendering
    - Limit to 10 levels, log warning if exceeded
    - _Requirements: 13.1_
  - [ ] 8.2 Write property test for deep nesting stability
    - **Property 18: Deep Nesting Stability**
    - **Validates: Requirements 13.1**
  - [ ] 8.3 Handle empty elements
    - Ensure empty paragraphs, cells render as empty widgets
    - _Requirements: 13.2_

- [ ] 9. Final Checkpoint
  - Ensure all tests pass, ask the user if questions arise.
